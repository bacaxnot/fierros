# Exercises Implementation Plan

Based on the spec defined in `packages/core/_specs_/contexts/training/exercises.md`.

## Requirements

1. **SearchExercisesByUser** use case: accepts `{ userId: string }`, delegates to `ExerciseRepository.searchByUserId`, returns `ExercisePrimitives[]`
2. **Design decision**: `searchByUserId` returns both system exercises (`userId = null`) and user-specific exercises - this is a repository-level concern, the use case simply delegates
3. **Shared test utilities**: `IdMother` and `TimestampMother` must be created as reusable test helpers
4. **Test infrastructure**: `ExerciseMother`, `ExerciseIdMother`, `MockExerciseRepository` for exercise module tests
5. **Test coverage**: Two scenarios - mixed user+system exercises, and system-only exercises

## Analysis

The domain layer is complete:

- `src/contexts/training/exercises/domain/exercise-id.ts` - EXISTS
- `src/contexts/training/exercises/domain/exercise-name.ts` - EXISTS
- `src/contexts/training/exercises/domain/exercise-description.ts` - EXISTS
- `src/contexts/training/exercises/domain/muscle-group.ts` - EXISTS
- `src/contexts/training/exercises/domain/muscle-involvement.ts` - EXISTS
- `src/contexts/training/exercises/domain/exercise-target-muscle.ts` - EXISTS
- `src/contexts/training/exercises/domain/exercise.ts` - EXISTS
- `src/contexts/training/exercises/domain/exercise-repository.ts` - EXISTS

What's missing:

- Application layer use case
- All test files and shared test utilities

## Folder Structure

```
packages/core/
├── tests/
│   ├── shared/
│   │   └── domain/
│   │       ├── id-mother.ts                                              # NEW - shared ID test helper
│   │       └── timestamp-mother.ts                                       # NEW - shared timestamp test helper
│   └── contexts/
│       └── training/
│           └── exercises/
│               ├── domain/
│               │   ├── exercise-id-mother.ts                             # NEW - exercise ID mother
│               │   ├── exercise-mother.ts                                # NEW - exercise aggregate mother
│               │   └── mock-exercise-repository.ts                       # NEW - mock repository
│               └── application/
│                   └── search-exercises-by-user.test.ts                  # NEW - use case test
└── src/
    └── contexts/
        └── training/
            └── exercises/
                ├── domain/
                │   ├── exercise-id.ts                                    # EXISTS
                │   ├── exercise-name.ts                                  # EXISTS
                │   ├── exercise-description.ts                           # EXISTS
                │   ├── muscle-group.ts                                   # EXISTS
                │   ├── muscle-involvement.ts                             # EXISTS
                │   ├── exercise-target-muscle.ts                         # EXISTS
                │   ├── exercise.ts                                       # EXISTS
                │   └── exercise-repository.ts                            # EXISTS
                └── application/
                    └── search-exercises-by-user.usecase.ts               # NEW - use case
```

## Implementation Details

### Shared Test Utilities

#### `tests/shared/domain/id-mother.ts`

```typescript
import { Id } from "../../../src/shared/domain/id";

export class IdMother {
  static random(): Id {
    return new Id();
  }
}
```

#### `tests/shared/domain/timestamp-mother.ts`

```typescript
export class Timestamp {
  constructor(public readonly value: string) {}
}

export class TimestampMother {
  static random(): Timestamp {
    const start = new Date(2020, 0, 1).getTime();
    const end = new Date().getTime();
    const randomTime = new Date(start + Math.random() * (end - start));
    return new Timestamp(randomTime.toISOString());
  }
}
```

### Exercise Test Infrastructure

#### `tests/contexts/training/exercises/domain/exercise-id-mother.ts`

```typescript
import { IdMother } from "../../../../shared/domain/id-mother";

export class ExerciseIdMother extends IdMother {}
```

#### `tests/contexts/training/exercises/domain/exercise-mother.ts`

```typescript
import { faker } from "@faker-js/faker";
import {
  Exercise,
  type ExercisePrimitives,
} from "../../../../src/contexts/training/exercises/domain/exercise";
import { ExerciseIdMother } from "./exercise-id-mother";
import { TimestampMother } from "../../../../shared/domain/timestamp-mother";

export class ExerciseMother {
  static create(params?: Partial<ExercisePrimitives>): Exercise {
    const primitives: ExercisePrimitives = {
      id: ExerciseIdMother.random().value,
      name: faker.lorem.words(2),
      description: faker.lorem.sentence(),
      userId: null,
      targetMuscles: [],
      defaultMetrics: [],
      createdAt: TimestampMother.random().value,
      updatedAt: TimestampMother.random().value,
      ...params,
    };
    return Exercise.fromPrimitives(primitives);
  }
}
```

#### `tests/contexts/training/exercises/domain/mock-exercise-repository.ts`

```typescript
import { mock } from "bun:test";
import type { Exercise } from "../../../../src/contexts/training/exercises/domain/exercise";
import { ExerciseRepository } from "../../../../src/contexts/training/exercises/domain/exercise-repository";

export class MockExerciseRepository extends ExerciseRepository {
  readonly save = mock(() => {});
  readonly search = mock(() => {});
  readonly searchByUserId = mock(() => {});
  readonly delete = mock(() => {});

  returnOnSearchByUserId(exercises: Exercise[]): void {
    this.searchByUserId.mockResolvedValue(exercises);
  }
}
```

### Use Case Test

#### `tests/contexts/training/exercises/application/search-exercises-by-user.test.ts`

```typescript
import { describe, it, expect, beforeEach } from "bun:test";
import { SearchExercisesByUser } from "../../../../../src/contexts/training/exercises/application/search-exercises-by-user.usecase";
import { ExerciseMother } from "../domain/exercise-mother";
import { MockExerciseRepository } from "../domain/mock-exercise-repository";

describe("SearchExercisesByUser", () => {
  let repository: MockExerciseRepository;
  let usecase: SearchExercisesByUser;

  beforeEach(() => {
    repository = new MockExerciseRepository();
    usecase = new SearchExercisesByUser(repository);
  });

  it("returns user exercises and system exercises as primitives", async () => {
    const userExercise = ExerciseMother.create({ userId: "user-1" });
    const systemExercise = ExerciseMother.create({ userId: null });
    repository.returnOnSearchByUserId([userExercise, systemExercise]);

    const result = await usecase.execute({ userId: "user-1" });

    expect(result).toEqual([
      userExercise.toPrimitives(),
      systemExercise.toPrimitives(),
    ]);
  });

  it("returns only system exercises when user has no exercises", async () => {
    const systemExercise = ExerciseMother.create({ userId: null });
    repository.returnOnSearchByUserId([systemExercise]);

    const result = await usecase.execute({ userId: "user-1" });

    expect(result).toEqual([systemExercise.toPrimitives()]);
  });
});
```

### Use Case (Production Code)

#### `src/contexts/training/exercises/application/search-exercises-by-user.usecase.ts`

```typescript
import { InferDependencies } from "../../../../../di/autoregister";
import { UserId } from "../../users/domain/user-id";
import type { ExercisePrimitives } from "../domain/exercise";
import { ExerciseRepository } from "../domain/exercise-repository";

@InferDependencies()
export class SearchExercisesByUser {
  constructor(private readonly repository: ExerciseRepository) {}

  async execute(params: { userId: string }): Promise<ExercisePrimitives[]> {
    const userId = new UserId(params.userId);
    const exercises = await this.repository.searchByUserId(userId);
    return exercises.map((exercise) => exercise.toPrimitives());
  }
}
```
