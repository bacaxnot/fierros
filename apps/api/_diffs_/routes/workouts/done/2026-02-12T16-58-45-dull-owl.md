# Workouts Endpoints Implementation Plan

Based on the spec defined in `apps/api/_specs_/routes/workouts.md`.

## Requirements

1. **GET /workouts**: List all workouts for the authenticated user. Orchestrates `SearchWorkoutsByUser` use case. Returns `WorkoutPrimitives[]` wrapped in `{ data }`.
2. **PUT /workouts/:id**: Start a new workout from a routine. Orchestrates `StartWorkoutFromRoutine` use case. Accepts `routineId` in body, `id` in params. Returns 201.
3. **POST /workouts/:id/finish**: Finish an ongoing workout. Orchestrates `FinishWorkout` use case. Accepts `id` in params. Returns 204.
4. **DELETE /workouts/:id**: Discard an ongoing workout. Orchestrates `DiscardWorkout` use case. Accepts `id` in params. Returns 204.

## Folder Structure

```
apps/api/src/
  controllers/
    workouts/
      get-workouts.ts              # NEW - list workouts controller
      put-workout.ts               # NEW - start workout controller
      post-finish-workout.ts       # NEW - finish workout controller
      delete-workout.ts            # NEW - discard workout controller
  routes/
    workouts.ts                    # NEW - workouts route file
  index.ts                         # UPDATE - register workouts route
```

## Implementation Details

### Controllers

#### `controllers/workouts/get-workouts.ts`

```typescript
import { container } from "@repo/core/container";
import { SearchWorkoutsByUser } from "@repo/core/contexts/training/workouts/application/search-workouts-by-user.usecase";
import { DomainError } from "@repo/core/shared/domain/domain-error";
import { factory } from "~/lib/factory";
import { domainError, internalServerError, json } from "~/lib/http-response";

export const getWorkoutsHandlers = factory.createHandlers(async (c) => {
  try {
    const useCase = container.get(SearchWorkoutsByUser);
    const user = c.get("user");
    const data = await useCase.execute({ userId: user.id });
    return json(c, { data });
  } catch (error: unknown) {
    if (error instanceof DomainError) {
      return domainError(c, error, 400);
    }
    return internalServerError(c);
  }
});
```

- Resolves `SearchWorkoutsByUser` from the DI container.
- Extracts `user.id` from the Hono context (set by auth middleware via `ProtectedVariables`).
- Calls `useCase.execute({ userId: string })` which returns `WorkoutPrimitives[]`.
- Wraps the result in `{ data }` and returns 200.
- Catches `DomainError` instances and returns 400; all other errors return 500.

#### `controllers/workouts/put-workout.ts`

```typescript
import { container } from "@repo/core/container";
import { StartWorkoutFromRoutine } from "@repo/core/contexts/training/workouts/application/start-workout-from-routine.usecase";
import { DomainError } from "@repo/core/shared/domain/domain-error";
import { zValidator } from "@hono/zod-validator";
import { z } from "zod";
import { factory } from "~/lib/factory";
import { created, domainError, internalServerError } from "~/lib/http-response";

export const putWorkoutParamsSchema = z.object({ id: z.string().uuid() });
export const putWorkoutBodySchema = z.object({ routineId: z.string().uuid() });

export const putWorkoutHandlers = factory.createHandlers(
  zValidator("param", putWorkoutParamsSchema),
  zValidator("json", putWorkoutBodySchema),
  async (c) => {
    try {
      const params = c.req.valid("param");
      const body = c.req.valid("json");
      const user = c.get("user");
      const useCase = container.get(StartWorkoutFromRoutine);
      await useCase.execute({
        workoutId: params.id,
        userId: user.id,
        routineId: body.routineId,
      });
      return created(c);
    } catch (error: unknown) {
      if (error instanceof DomainError) {
        return domainError(c, error, 400);
      }
      return internalServerError(c);
    }
  },
);
```

- Validates `:id` param as UUID using `putWorkoutParamsSchema`.
- Validates JSON body with `routineId` as UUID using `putWorkoutBodySchema`.
- Resolves `StartWorkoutFromRoutine` from the DI container.
- Calls `useCase.execute({ workoutId, userId, routineId })` which returns `Promise<void>`.
- Returns 201 on success.
- Catches `DomainError` (e.g. `UnauthorizedResourceAccessError` if routine doesn't belong to user) and returns 400; all other errors return 500.

#### `controllers/workouts/post-finish-workout.ts`

```typescript
import { container } from "@repo/core/container";
import { FinishWorkout } from "@repo/core/contexts/training/workouts/application/finish-workout.usecase";
import { DomainError } from "@repo/core/shared/domain/domain-error";
import { zValidator } from "@hono/zod-validator";
import { z } from "zod";
import { factory } from "~/lib/factory";
import { domainError, internalServerError, noContent } from "~/lib/http-response";

export const postFinishWorkoutParamsSchema = z.object({ id: z.string().uuid() });

export const postFinishWorkoutHandlers = factory.createHandlers(
  zValidator("param", postFinishWorkoutParamsSchema),
  async (c) => {
    try {
      const useCase = container.get(FinishWorkout);
      const params = c.req.valid("param");
      const user = c.get("user");
      await useCase.execute({ userId: user.id, workoutId: params.id });
      return noContent(c);
    } catch (error: unknown) {
      if (error instanceof DomainError) {
        return domainError(c, error, 400);
      }
      return internalServerError(c);
    }
  },
);
```

- Validates `:id` param as UUID using `postFinishWorkoutParamsSchema`.
- Resolves `FinishWorkout` from the DI container.
- Calls `useCase.execute({ userId, workoutId })` which returns `Promise<void>`.
- Returns 204 on success.
- Catches `DomainError` (e.g. `UnauthorizedResourceAccessError`, `WorkoutAlreadyFinishedError`) and returns 400; all other errors return 500.

#### `controllers/workouts/delete-workout.ts`

```typescript
import { container } from "@repo/core/container";
import { DiscardWorkout } from "@repo/core/contexts/training/workouts/application/discard-workout.usecase";
import { DomainError } from "@repo/core/shared/domain/domain-error";
import { zValidator } from "@hono/zod-validator";
import { z } from "zod";
import { factory } from "~/lib/factory";
import { domainError, internalServerError, noContent } from "~/lib/http-response";

export const deleteWorkoutParamsSchema = z.object({ id: z.string().uuid() });

export const deleteWorkoutHandlers = factory.createHandlers(
  zValidator("param", deleteWorkoutParamsSchema),
  async (c) => {
    try {
      const useCase = container.get(DiscardWorkout);
      const params = c.req.valid("param");
      const user = c.get("user");
      await useCase.execute({ userId: user.id, workoutId: params.id });
      return noContent(c);
    } catch (error: unknown) {
      if (error instanceof DomainError) {
        return domainError(c, error, 400);
      }
      return internalServerError(c);
    }
  },
);
```

- Validates `:id` param as UUID using `deleteWorkoutParamsSchema`.
- Resolves `DiscardWorkout` from the DI container.
- Calls `useCase.execute({ userId, workoutId })` which returns `Promise<void>`.
- Returns 204 on success.
- Catches `DomainError` (e.g. `UnauthorizedResourceAccessError`, `WorkoutAlreadyFinishedError`) and returns 400; all other errors return 500.

### Routes

#### `routes/workouts.ts`

```typescript
import { Hono } from "hono";
import { deleteWorkoutHandlers } from "~/controllers/workouts/delete-workout";
import { getWorkoutsHandlers } from "~/controllers/workouts/get-workouts";
import { postFinishWorkoutHandlers } from "~/controllers/workouts/post-finish-workout";
import { putWorkoutHandlers } from "~/controllers/workouts/put-workout";

export const workoutsApp = new Hono()
  .get("/", ...getWorkoutsHandlers)
  .put("/:id", ...putWorkoutHandlers)
  .post("/:id/finish", ...postFinishWorkoutHandlers)
  .delete("/:id", ...deleteWorkoutHandlers);

export type WorkoutsAppType = typeof workoutsApp;
```

- Mounts four routes that map to the full paths when registered on the parent app:
  - `GET /` maps to `GET /workouts`
  - `PUT /:id` maps to `PUT /workouts/:id`
  - `POST /:id/finish` maps to `POST /workouts/:id/finish`
  - `DELETE /:id` maps to `DELETE /workouts/:id`
- Exports `WorkoutsAppType` for end-to-end type-safe RPC clients.

### Index Registration

#### `index.ts`

Add the import at the top of the file:

```typescript
import { workoutsApp } from "~/routes/workouts";
```

Chain `.route("/workouts", workoutsApp)` onto the app. The updated health check and route registration section becomes:

```typescript
  .get("/health", (c) => c.json({ status: "ok" }))
  .route("/workouts", workoutsApp);
```

If other route registrations already exist (e.g. `.route("/exercises", exercisesApp)`), chain this after the last existing `.route(...)` call. The TODO comment block (`// TODO: Add domain routes here`) should be removed if still present.
