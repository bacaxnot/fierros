# Routines Endpoints Implementation Plan

Based on the spec defined in `apps/api/_specs_/routes/routines.md`.

## Requirements

1. **GET /routines**: List all routines for the authenticated user. Orchestrates `SearchRoutinesByUser` use case. Returns `RoutinePrimitives[]` wrapped in `{ data }`.
2. **PUT /routines/:id**: Create a new routine. Orchestrates `CreateRoutine` use case. Validates UUID param and JSON body with name, description, and blocks. Returns 201.
3. **PATCH /routines/:id**: Update an existing routine. Orchestrates `UpdateRoutine` use case (two-arg signature: params + payload). All body fields optional. Returns 204.
4. **DELETE /routines/:id**: Delete a routine. Orchestrates `DeleteRoutine` use case. Validates UUID param. Returns 204.

## Folder Structure

```
apps/api/src/
  controllers/
    routines/
      schemas.ts                  # NEW - shared Zod schemas for routine blocks/sets/metrics
      get-routines.ts             # NEW - GET / handler
      put-routine.ts              # NEW - PUT /:id handler
      patch-routine.ts            # NEW - PATCH /:id handler
      delete-routine.ts           # NEW - DELETE /:id handler
  routes/
    routines.ts                   # NEW - route definitions
  index.ts                        # UPDATE - register routines route
```

## Implementation Details

### Shared Schemas

#### `controllers/routines/schemas.ts`

```typescript
import { z } from "zod";

/**
 * Matches MetricValuePrimitives from core:
 *   { value: number; unit: string }
 */
export const metricValueSchema = z.object({
  value: z.number(),
  unit: z.string(),
});

/**
 * Matches MetricValueRangePrimitives from core:
 *   { min: MetricValuePrimitives | null; max: MetricValuePrimitives | null }
 */
export const metricValueRangeSchema = z.object({
  min: metricValueSchema.nullable(),
  max: metricValueSchema.nullable(),
});

/**
 * Matches RoutineSetMetricPrimitives from core:
 *   { metricId: string; targetRange: MetricValueRangePrimitives | null; targetValue: MetricValuePrimitives | null; lastValue: MetricValuePrimitives | null }
 */
export const routineSetMetricSchema = z.object({
  metricId: z.string().uuid(),
  targetRange: metricValueRangeSchema.nullable(),
  targetValue: metricValueSchema.nullable(),
  lastValue: metricValueSchema.nullable(),
});

/**
 * Matches RoutineSetPrimitives from core:
 *   { order: number; exerciseId: string; notes: string | null; restTime: number | null; metrics: RoutineSetMetricPrimitives[] }
 */
export const routineSetSchema = z.object({
  order: z.number(),
  exerciseId: z.string().uuid(),
  notes: z.string().nullable(),
  restTime: z.number().nullable(),
  metrics: z.array(routineSetMetricSchema),
});

/**
 * Matches RoutineBlockPrimitives from core:
 *   { order: number; notes: string | null; defaultRestTime: number | null; sets: RoutineSetPrimitives[] }
 */
export const routineBlockSchema = z.object({
  order: z.number(),
  notes: z.string().nullable(),
  defaultRestTime: z.number().nullable(),
  sets: z.array(routineSetSchema),
});
```

- Shared schemas live in a dedicated file to avoid circular imports and duplication between PUT and PATCH controllers.
- Each schema mirrors the exact shape of the corresponding `*Primitives` type from `packages/core`.
- `RoutineSetPrimitives` includes a `notes` field that is not in the original API spec but exists in the domain model; we include it here to match the actual primitive types.
- `RoutineSetMetricPrimitives` uses `metricId`, `targetRange`, `targetValue`, and `lastValue` (not `exerciseMetricId` / `target` as in the abbreviated spec). The Zod schemas match the real domain primitives.

### Controllers

#### `controllers/routines/get-routines.ts`

```typescript
import { container } from "@repo/core/container";
import { SearchRoutinesByUser } from "@repo/core/contexts/training/routines/application/search-routines-by-user.usecase";
import { DomainError } from "@repo/core/shared/domain/domain-error";
import { factory } from "~/lib/factory";
import { domainError, internalServerError, json } from "~/lib/http-response";

export const getRoutinesHandlers = factory.createHandlers(async (c) => {
  try {
    const useCase = container.get(SearchRoutinesByUser);
    const user = c.get("user");
    const data = await useCase.execute({ userId: user.id });
    return json(c, { data });
  } catch (error: unknown) {
    if (error instanceof DomainError) {
      return domainError(c, error, 400);
    }
    return internalServerError(c);
  }
});
```

- Resolves `SearchRoutinesByUser` from the DI container.
- Extracts `user.id` from the Hono context (set by auth middleware via `ProtectedVariables`).
- Calls `useCase.execute({ userId: string })` which returns `RoutinePrimitives[]`.
- Wraps the result in `{ data }` and returns 200.
- Catches `DomainError` instances and returns 400; all other errors return 500.

#### `controllers/routines/put-routine.ts`

```typescript
import { zValidator } from "@hono/zod-validator";
import { container } from "@repo/core/container";
import { CreateRoutine } from "@repo/core/contexts/training/routines/application/create-routine.usecase";
import { DomainError } from "@repo/core/shared/domain/domain-error";
import { z } from "zod";
import { factory } from "~/lib/factory";
import { created, domainError, internalServerError } from "~/lib/http-response";
import { routineBlockSchema } from "./schemas";

export const putRoutineParamsSchema = z.object({
  id: z.string().uuid(),
});

export const putRoutineBodySchema = z.object({
  name: z.string(),
  description: z.string().nullable(),
  blocks: z.array(routineBlockSchema),
});

export const putRoutineHandlers = factory.createHandlers(
  zValidator("param", putRoutineParamsSchema),
  zValidator("json", putRoutineBodySchema),
  async (c) => {
    try {
      const params = c.req.valid("param");
      const body = c.req.valid("json");
      const user = c.get("user");
      const useCase = container.get(CreateRoutine);
      await useCase.execute({
        id: params.id,
        userId: user.id,
        name: body.name,
        description: body.description,
        blocks: body.blocks,
      });
      return created(c);
    } catch (error: unknown) {
      if (error instanceof DomainError) {
        return domainError(c, error, 400);
      }
      return internalServerError(c);
    }
  },
);
```

- Validates `:id` param as UUID and JSON body with `name`, `description`, and `blocks`.
- `CreateRoutine.execute` signature: `{ id, userId, name, description, blocks }`.
- `userId` comes from auth context, not the request body.
- Returns 201 on success.

#### `controllers/routines/patch-routine.ts`

```typescript
import { zValidator } from "@hono/zod-validator";
import { container } from "@repo/core/container";
import { UpdateRoutine } from "@repo/core/contexts/training/routines/application/update-routine.usecase";
import { DomainError } from "@repo/core/shared/domain/domain-error";
import { z } from "zod";
import { factory } from "~/lib/factory";
import { domainError, internalServerError, noContent } from "~/lib/http-response";
import { routineBlockSchema } from "./schemas";

export const patchRoutineParamsSchema = z.object({
  id: z.string().uuid(),
});

export const patchRoutineBodySchema = z.object({
  name: z.string().optional(),
  description: z.string().nullable().optional(),
  blocks: z.array(routineBlockSchema).optional(),
});

export const patchRoutineHandlers = factory.createHandlers(
  zValidator("param", patchRoutineParamsSchema),
  zValidator("json", patchRoutineBodySchema),
  async (c) => {
    try {
      const useCase = container.get(UpdateRoutine);
      const params = c.req.valid("param");
      const body = c.req.valid("json");
      const user = c.get("user");
      await useCase.execute(
        { userId: user.id, routineId: params.id },
        body,
      );
      return noContent(c);
    } catch (error: unknown) {
      if (error instanceof DomainError) {
        return domainError(c, error, 400);
      }
      return internalServerError(c);
    }
  },
);
```

- All body fields are optional (partial update).
- `UpdateRoutine.execute` takes **two arguments**: `(params: { userId, routineId }, payload: { name?, description?, blocks? })`.
- The `body` object (validated by Zod with all-optional fields) is passed directly as the second argument since its shape matches `UpdateRoutinePayload`.
- Returns 204 on success.

#### `controllers/routines/delete-routine.ts`

```typescript
import { zValidator } from "@hono/zod-validator";
import { container } from "@repo/core/container";
import { DeleteRoutine } from "@repo/core/contexts/training/routines/application/delete-routine.usecase";
import { DomainError } from "@repo/core/shared/domain/domain-error";
import { z } from "zod";
import { factory } from "~/lib/factory";
import { domainError, internalServerError, noContent } from "~/lib/http-response";

export const deleteRoutineParamsSchema = z.object({
  id: z.string().uuid(),
});

export const deleteRoutineHandlers = factory.createHandlers(
  zValidator("param", deleteRoutineParamsSchema),
  async (c) => {
    try {
      const useCase = container.get(DeleteRoutine);
      const params = c.req.valid("param");
      const user = c.get("user");
      await useCase.execute({ userId: user.id, routineId: params.id });
      return noContent(c);
    } catch (error: unknown) {
      if (error instanceof DomainError) {
        return domainError(c, error, 400);
      }
      return internalServerError(c);
    }
  },
);
```

- Only validates the `:id` param as UUID. No request body.
- `DeleteRoutine.execute` signature: `{ userId, routineId }`.
- Returns 204 on success.

### Routes

#### `routes/routines.ts`

```typescript
import { Hono } from "hono";
import { deleteRoutineHandlers } from "~/controllers/routines/delete-routine";
import { getRoutinesHandlers } from "~/controllers/routines/get-routines";
import { patchRoutineHandlers } from "~/controllers/routines/patch-routine";
import { putRoutineHandlers } from "~/controllers/routines/put-routine";

export const routinesApp = new Hono()
  .get("/", ...getRoutinesHandlers)
  .put("/:id", ...putRoutineHandlers)
  .patch("/:id", ...patchRoutineHandlers)
  .delete("/:id", ...deleteRoutineHandlers);

export type RoutinesAppType = typeof routinesApp;
```

- Mounts all four handlers using the spread pattern.
- `GET /` maps to `GET /routines` when registered on the parent app.
- Exports `RoutinesAppType` for end-to-end type-safe RPC clients.

### Index Registration

#### `index.ts`

Add the import at the top of the file:

```typescript
import { routinesApp } from "~/routes/routines";
```

Chain `.route("/routines", routinesApp)` onto the app, replacing the TODO comment block. The updated section becomes:

```typescript
  .get("/health", (c) => c.json({ status: "ok" }))
  .route("/routines", routinesApp);
```

This removes the placeholder comment `// TODO: Add domain routes here` and its example line, replacing them with the actual route registration.

## Notes

- The Zod schemas are built to match the **actual domain primitive types** from `packages/core`, not the abbreviated spec DTOs. Key differences from the spec:
  - `RoutineSetPrimitives` includes a `notes` field.
  - `RoutineSetMetricPrimitives` uses `metricId` (not `exerciseMetricId`), `targetRange`, `targetValue`, and `lastValue` (not a single `target: number`).
- Zod 4 (`zod@4.1.13`) is used. The `z.object`, `z.string().uuid()`, `z.number()`, `z.array()`, `.nullable()`, and `.optional()` APIs are compatible with Zod 4.
- All `userId` values come from the auth session context (`c.get("user").id`), never from the request body.
